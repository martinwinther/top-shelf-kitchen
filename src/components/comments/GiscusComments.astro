---
/**
 * GiscusComments - GitHub Discussions-powered comments
 *
 * Renders Giscus comment widget when:
 * - comments feature is enabled
 * - giscus config is properly set (repo, repoId, categoryId)
 * - user has granted consent (analytics consent used as gating mechanism)
 *
 * Consent gating rationale:
 * Giscus embeds an iframe from giscus.app which may set cookies and track users.
 * We treat this as non-essential and gate it behind analytics consent to keep
 * the consent categories minimal. Users must opt-in before comments load.
 */

import { siteConfig } from '../../config/site';
import GlassCard from '../ui/GlassCard.astro';

const { comments, legal } = siteConfig.features;
const giscus = comments.giscus;

// Check if giscus is properly configured
const isConfigured = Boolean(
  giscus.repo && giscus.repoId && giscus.categoryId
);

// In development, show placeholder for unconfigured state
const isDev = import.meta.env.DEV;
---

{isConfigured ? (
  <section class="comments-section no-print" data-pagefind-ignore>
    <GlassCard>
      <h2 class="comments-title">Comments</h2>
      
      {/* Consent gate container - JS will check consent and either show comments or the gate message */}
      <div
        id="giscus-container"
        class="giscus-container"
        data-repo={giscus.repo}
        data-repo-id={giscus.repoId}
        data-category={giscus.category}
        data-category-id={giscus.categoryId}
        data-mapping={giscus.mapping || 'pathname'}
        data-strict={giscus.strict !== false ? '1' : '0'}
        data-reactions-enabled={giscus.reactionsEnabled !== false ? '1' : '0'}
        data-emit-metadata={giscus.emitMetadata ? '1' : '0'}
        data-input-position={giscus.inputPosition || 'bottom'}
        data-theme={giscus.theme || 'noborder_dark'}
        data-lang={giscus.lang || 'en'}
        data-consent-version={legal.consentVersion}
      >
        {/* This will be replaced by JS based on consent status */}
        <div class="giscus-loading">
          <span class="loading-text">Loading comments...</span>
        </div>
      </div>
      
      {/* Fallback shown when consent not granted - hidden by default, JS shows it */}
      <div id="giscus-consent-gate" class="consent-gate" hidden>
        <p class="consent-message">
          Comments are disabled until you allow optional cookies.
        </p>
        <button type="button" class="consent-button" data-action="manage-consent">
          Manage preferences
        </button>
      </div>
    </GlassCard>
  </section>

  <script>
    (function() {
      const container = document.getElementById('giscus-container');
      const consentGate = document.getElementById('giscus-consent-gate');
      
      if (!container || !consentGate) return;

      const consentVersion = container.dataset.consentVersion || '1';

      // Read consent from cookie/localStorage (mirrors consent.ts logic)
      function readConsent(): { analytics: boolean } | null {
        const CONSENT_COOKIE = 'tsk_consent';
        const CONSENT_STORAGE = 'tsk.consent';

        function getCookie(name: string): string | null {
          const cookies = document.cookie.split(';');
          for (const cookie of cookies) {
            const [cookieName, ...valueParts] = cookie.split('=');
            if (cookieName.trim() === name) {
              try {
                return decodeURIComponent(valueParts.join('='));
              } catch {
                return valueParts.join('=');
              }
            }
          }
          return null;
        }

        // Try cookie first
        const cookieValue = getCookie(CONSENT_COOKIE);
        if (cookieValue) {
          try {
            const parsed = JSON.parse(cookieValue);
            if (parsed && parsed.version === consentVersion && parsed.necessary === true) {
              return parsed;
            }
          } catch {}
        }

        // Try localStorage
        try {
          const stored = localStorage.getItem(CONSENT_STORAGE);
          if (stored) {
            const parsed = JSON.parse(stored);
            if (parsed && parsed.version === consentVersion && parsed.necessary === true) {
              return parsed;
            }
          }
        } catch {}

        return null;
      }

      // Check if we have analytics consent (used to gate comments as non-essential)
      const consent = readConsent();
      const hasAnalyticsConsent = consent?.analytics === true;

      if (hasAnalyticsConsent) {
        // Load Giscus
        loadGiscus();
      } else {
        // Show consent gate
        container.innerHTML = '';
        consentGate.hidden = false;
      }

      function loadGiscus() {
        // Prevent double-loading
        if (container.querySelector('.giscus') || container.querySelector('.giscus-frame')) {
          return;
        }

        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.async = true;
        script.crossOrigin = 'anonymous';
        
        // Read config from container data attributes
        script.setAttribute('data-repo', container.dataset.repo || '');
        script.setAttribute('data-repo-id', container.dataset.repoId || '');
        script.setAttribute('data-category', container.dataset.category || '');
        script.setAttribute('data-category-id', container.dataset.categoryId || '');
        script.setAttribute('data-mapping', container.dataset.mapping || 'pathname');
        script.setAttribute('data-strict', container.dataset.strict || '1');
        script.setAttribute('data-reactions-enabled', container.dataset.reactionsEnabled || '1');
        script.setAttribute('data-emit-metadata', container.dataset.emitMetadata || '0');
        script.setAttribute('data-input-position', container.dataset.inputPosition || 'bottom');
        script.setAttribute('data-theme', container.dataset.theme || 'noborder_dark');
        script.setAttribute('data-lang', container.dataset.lang || 'en');

        // Clear loading state and append script
        container.innerHTML = '';
        container.appendChild(script);
      }

      // Handle manage consent button click
      consentGate.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target.closest('[data-action="manage-consent"]')) {
          e.preventDefault();
          // Try to open consent modal via global API or custom event
          if (typeof (window as any).tskOpenConsentModal === 'function') {
            (window as any).tskOpenConsentModal();
          } else {
            // Fallback: dispatch custom event
            window.dispatchEvent(new Event('tsk:open-consent'));
          }
        }
      });
    })();
  </script>
) : isDev ? (
  <section class="comments-section no-print" data-pagefind-ignore>
    <GlassCard>
      <h2 class="comments-title">Comments</h2>
      <div class="placeholder-message">
        <p class="placeholder-text">
          ðŸ’¬ Comments not configured
        </p>
        <p class="placeholder-hint">
          Set <code>features.comments.giscus</code> in <code>src/config/site.ts</code> to enable.
        </p>
      </div>
    </GlassCard>
  </section>
) : null}

<style>
  .comments-section {
    margin-top: 2rem;
  }

  .comments-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    margin: 0 0 1.25rem 0;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--glass-border);
  }

  .giscus-container {
    min-height: 150px;
  }

  .giscus-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    color: var(--muted);
    font-size: 0.875rem;
  }

  .loading-text {
    opacity: 0.7;
  }

  /* Consent gate styles */
  .consent-gate {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    text-align: center;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
  }

  .consent-message {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 0;
  }

  .consent-button {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: background-color 0.15s ease, border-color 0.15s ease;
  }

  .consent-button:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .consent-button:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* DEV placeholder styles */
  .placeholder-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    text-align: center;
    background: rgba(255, 255, 255, 0.02);
    border: 1px dashed var(--glass-border);
    border-radius: var(--radius-md);
  }

  .placeholder-text {
    color: var(--muted);
    font-size: 0.9rem;
    margin: 0;
  }

  .placeholder-hint {
    color: var(--muted);
    font-size: 0.8rem;
    margin: 0;
    opacity: 0.7;
  }

  .placeholder-hint code {
    background: rgba(255, 255, 255, 0.08);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
  }

  /* Giscus iframe styling overrides */
  :global(.giscus) {
    width: 100%;
  }

  :global(.giscus-frame) {
    width: 100%;
    border: none;
  }

  @media (prefers-reduced-motion: reduce) {
    .consent-button {
      transition: none;
    }
  }
</style>

