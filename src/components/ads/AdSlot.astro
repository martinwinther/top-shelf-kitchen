---
/**
 * AdSlot - Reusable AdSense ad slot component
 *
 * Renders an AdSense <ins> element with proper configuration.
 * Only pushes ad request if user has given consent.
 *
 * In dev mode with missing config: shows placeholder.
 * In dev mode with no consent: shows "Ads disabled (no consent)" placeholder.
 * In prod with no consent or missing config: renders nothing.
 */

import { siteConfig } from '../../config/site';
import GlassCard from '../ui/GlassCard.astro';

interface Props {
  /** The AdSense slot ID */
  slotId: string;
  /** Ad format */
  format?: 'auto' | 'vertical' | 'horizontal' | 'rectangle';
  /** Enable full-width responsive behavior */
  fullWidthResponsive?: boolean;
  /** Additional CSS classes */
  class?: string;
  /** Inline styles */
  style?: string;
  /** Label for dev placeholder */
  label?: string;
}

const {
  slotId,
  format = 'auto',
  fullWidthResponsive = true,
  class: className = '',
  style = '',
  label = 'Ad slot',
} = Astro.props;

const { ads, legal } = siteConfig.features;
const clientId = ads.adsense.clientId;
const consentVersion = legal.consentVersion;

// Check if we have valid configuration
const hasValidConfig =
  ads.enabled &&
  clientId.trim().length > 0 &&
  slotId.trim().length > 0;

const isDev = import.meta.env.DEV;

// Build container classes
const containerClasses = [
  'ad-slot',
  'no-print',
  className,
].filter(Boolean).join(' ');
---

{/* Dev mode: Show placeholder if config is missing */}
{!hasValidConfig && isDev && (
  <div class={containerClasses} style={style}>
    <GlassCard class="ad-placeholder-card">
      <div class="ad-placeholder-content">
        <span class="ad-placeholder-icon">ðŸ“¢</span>
        <span class="ad-placeholder-text">{label}</span>
        <span class="ad-placeholder-hint">(missing config)</span>
      </div>
    </GlassCard>
  </div>
)}

{/* Valid config: Render consent-gated ad slot */}
{hasValidConfig && (
  <div
    class={containerClasses}
    style={style}
    data-ad-slot-container
    data-consent-version={consentVersion}
    data-is-dev={isDev.toString()}
    data-label={label}
  >
    {/* Placeholder shown when no consent (dev only) */}
    <div class="ad-no-consent-placeholder" hidden>
      <GlassCard class="ad-placeholder-card">
        <div class="ad-placeholder-content">
          <span class="ad-placeholder-icon">ðŸš«</span>
          <span class="ad-placeholder-text">{label}</span>
          <span class="ad-placeholder-hint">Ads disabled (no consent)</span>
        </div>
      </GlassCard>
    </div>

    {/* Actual ad slot - hidden until consent confirmed */}
    <ins
      class="adsbygoogle ad-slot-ins"
      style="display:none"
      data-ad-client={clientId}
      data-ad-slot={slotId}
      data-ad-format={format}
      data-full-width-responsive={fullWidthResponsive ? 'true' : 'false'}
    />
  </div>
)}

<script>
  (function() {
    try {
      var CONSENT_COOKIE = 'tsk_consent';
      var CONSENT_STORAGE = 'tsk.consent';

      // Find all ad slot containers on this page
      var containers = document.querySelectorAll('[data-ad-slot-container]');

      if (containers.length === 0) return;

      // Read consent
      function getCookie(name) {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i];
          var parts = cookie.split('=');
          if (parts[0].trim() === name) {
            try {
              return decodeURIComponent(parts.slice(1).join('='));
            } catch (e) {
              return parts.slice(1).join('=');
            }
          }
        }
        return null;
      }

      function readConsent(version) {
        // Try cookie first
        var cookieValue = getCookie(CONSENT_COOKIE);
        if (cookieValue) {
          try {
            var parsed = JSON.parse(cookieValue);
            if (parsed && parsed.version === version && parsed.necessary === true) {
              return parsed;
            }
          } catch (e) {}
        }

        // Try localStorage
        try {
          var stored = localStorage.getItem(CONSENT_STORAGE);
          if (stored) {
            var parsed = JSON.parse(stored);
            if (parsed && parsed.version === version && parsed.necessary === true) {
              return parsed;
            }
          }
        } catch (e) {}

        return null;
      }

      containers.forEach(function(container) {
        var version = container.getAttribute('data-consent-version') || '1';
        var isDev = container.getAttribute('data-is-dev') === 'true';
        var consent = readConsent(version);
        var hasAdsConsent = consent && consent.ads === true;

        var placeholder = container.querySelector('.ad-no-consent-placeholder');
        var insElement = container.querySelector('.ad-slot-ins');

        if (hasAdsConsent && insElement) {
          // Show the ad slot and push
          insElement.style.display = 'block';
          if (placeholder) placeholder.hidden = true;

          // Only push if adsbygoogle exists (script loaded)
          if (window.adsbygoogle) {
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          } else {
            // Wait for AdSense script to load
            var checkInterval = setInterval(function() {
              if (window.adsbygoogle) {
                clearInterval(checkInterval);
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              }
            }, 100);

            // Give up after 5 seconds
            setTimeout(function() {
              clearInterval(checkInterval);
            }, 5000);
          }
        } else {
          // No consent
          if (isDev && placeholder) {
            // Show placeholder in dev
            placeholder.hidden = false;
            if (insElement) insElement.style.display = 'none';
          } else {
            // In prod, just hide everything
            container.style.display = 'none';
          }
        }
      });
    } catch (e) {
      // Fail silently
    }
  })();
</script>

<style>
  .ad-slot {
    /* Ensure container never collapses */
    min-width: 0;
  }

  .ad-placeholder-card {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100px;
    border-style: dashed;
  }

  .ad-placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-align: center;
  }

  .ad-placeholder-icon {
    font-size: 1.5rem;
    opacity: 0.6;
  }

  .ad-placeholder-text {
    font-size: 0.875rem;
    color: var(--muted);
    font-weight: 500;
  }

  .ad-placeholder-hint {
    font-size: 0.75rem;
    color: var(--muted);
    opacity: 0.6;
  }

  .ad-no-consent-placeholder[hidden] {
    display: none;
  }

  /* Hide ads in print mode */
  @media print {
    .no-print {
      display: none !important;
    }
  }
</style>
