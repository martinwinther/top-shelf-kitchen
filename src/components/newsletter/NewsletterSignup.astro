---
/**
 * NewsletterSignup - Minimalist newsletter signup module
 * 
 * Supports two modes:
 * - embed: Renders provider HTML (Mailchimp/ConvertKit/Buttondown) with scripts stripped
 * - endpoint: Renders a simple email form that posts to a configured URL
 * 
 * @example
 * <NewsletterSignup />
 * <NewsletterSignup compact />
 */

import { siteConfig } from '../../config/site';
import GlassCard from '../ui/GlassCard.astro';
import Button from '../ui/Button.astro';

interface Props {
  /** Compact mode for tighter spaces (e.g., recipe pages) */
  compact?: boolean;
}

const { compact = false } = Astro.props;
const { newsletter } = siteConfig.features;

// Early return if newsletter is disabled or provider is none
const isEnabled = newsletter.enabled && newsletter.provider !== 'none';

/**
 * Sanitize embed HTML by stripping <script> tags
 * This prevents XSS attacks while preserving forms, inputs, and iframes
 */
function sanitizeEmbedHtml(html: string): string {
  // Remove <script>...</script> tags (including multiline)
  return html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
}

const embedHtml = newsletter.provider === 'embed' && newsletter.embed?.html
  ? sanitizeEmbedHtml(newsletter.embed.html)
  : '';

const endpointConfig = newsletter.endpoint;
const fieldName = endpointConfig?.fieldName || 'email';
const method = endpointConfig?.method || 'POST';
const hiddenFields = endpointConfig?.hiddenFields || {};
---

{isEnabled && (
  <section
    class:list={['newsletter-signup', 'no-print', { 'newsletter-signup--compact': compact }]}
    data-pagefind-ignore
  >
    <GlassCard>
      <div class="newsletter-inner">
        {(newsletter.title || newsletter.description) && (
          <div class="newsletter-header">
            {newsletter.title && <h3 class="newsletter-title">{newsletter.title}</h3>}
            {newsletter.description && <p class="newsletter-description">{newsletter.description}</p>}
          </div>
        )}

        {newsletter.provider === 'embed' && embedHtml && (
          <div class="newsletter-embed" set:html={embedHtml} />
        )}

        {newsletter.provider === 'endpoint' && endpointConfig?.actionUrl && (
          <form
            class="newsletter-form"
            action={endpointConfig.actionUrl}
            method={method}
          >
            {Object.entries(hiddenFields).map(([name, value]) => (
              <input type="hidden" name={name} value={value} />
            ))}
            <div class="newsletter-form-row">
              <input
                type="email"
                name={fieldName}
                required
                placeholder="your@email.com"
                class="newsletter-input"
                autocomplete="email"
              />
              <Button type="submit" variant="primary" size={compact ? 'sm' : 'md'}>
                Subscribe
              </Button>
            </div>
            <p class="newsletter-hint">You'll be asked to confirm via email.</p>
          </form>
        )}
      </div>
    </GlassCard>
  </section>
)}

<style>
  .newsletter-signup {
    width: 100%;
    max-width: 560px;
    margin: 0 auto;
  }

  .newsletter-signup--compact {
    max-width: 480px;
  }

  .newsletter-inner {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }

  .newsletter-header {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .newsletter-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
  }

  .newsletter-signup--compact .newsletter-title {
    font-size: 1.125rem;
  }

  .newsletter-description {
    font-size: 0.9375rem;
    color: var(--muted);
    margin: 0;
  }

  .newsletter-signup--compact .newsletter-description {
    font-size: 0.875rem;
  }

  /* Embed styles - normalize common provider forms */
  .newsletter-embed {
    /* Reset common provider styles to blend with our design */
    --embed-radius: var(--radius-md);
  }

  .newsletter-embed :global(form) {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .newsletter-embed :global(input[type="email"]),
  .newsletter-embed :global(input[type="text"]) {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    color: var(--text);
    font-size: 1rem;
    width: 100%;
    box-sizing: border-box;
  }

  .newsletter-embed :global(input::placeholder) {
    color: var(--muted);
  }

  .newsletter-embed :global(button),
  .newsletter-embed :global(input[type="submit"]) {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: var(--radius-md);
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  .newsletter-embed :global(button:hover),
  .newsletter-embed :global(input[type="submit"]:hover) {
    opacity: 0.9;
  }

  /* Endpoint form styles */
  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .newsletter-form-row {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (min-width: 480px) {
    .newsletter-form-row {
      flex-direction: row;
    }
  }

  .newsletter-input {
    flex: 1;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    padding: 0.75rem 1rem;
    color: var(--text);
    font-size: 1rem;
    min-width: 0;
    transition: border-color 0.15s ease;
  }

  .newsletter-input::placeholder {
    color: var(--muted);
  }

  .newsletter-input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .newsletter-hint {
    font-size: 0.8125rem;
    color: var(--muted);
    margin: 0;
  }

  .newsletter-signup--compact .newsletter-hint {
    font-size: 0.75rem;
  }
</style>


