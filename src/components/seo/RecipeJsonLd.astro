---
/**
 * RecipeJsonLd - Schema.org Recipe JSON-LD component
 */

import { minutesToIso8601, formatIngredientForJsonLd } from '../../lib/seo';

type ImageData =
  | string
  | {
      src: string;
      alt?: string;
      width?: number;
      height?: number;
    }
  | undefined;

interface Props {
  siteUrl: string;
  slug: string;
  recipe: {
    title: string;
    description: string;
    category: string;
    cuisine: string;
    servingsDefault: number;
    times: {
      prepMinutes: number;
      cookMinutes: number;
    };
    ingredients: Array<{
      amount: number;
      unit?: string;
      name: string;
      note?: string;
    }>;
    steps: string[];
    image?: ImageData;
    publishedAt?: Date;
  };
  ogImagesEnabled: boolean;
}

const { siteUrl, slug, recipe, ogImagesEnabled } = Astro.props;

const recipeUrl = `${siteUrl}/recipes/${slug}`;
const totalMinutes = recipe.times.prepMinutes + recipe.times.cookMinutes;

// Build JSON-LD object
const jsonLd: Record<string, unknown> = {
  '@context': 'https://schema.org',
  '@type': 'Recipe',
  name: recipe.title,
  description: recipe.description,
  url: recipeUrl,
  recipeCategory: recipe.category,
  recipeCuisine: recipe.cuisine,
  recipeYield: `${recipe.servingsDefault} servings`,
  prepTime: minutesToIso8601(recipe.times.prepMinutes),
  cookTime: minutesToIso8601(recipe.times.cookMinutes),
  totalTime: minutesToIso8601(totalMinutes),
  recipeIngredient: recipe.ingredients.map((ing) =>
    formatIngredientForJsonLd(ing.amount, ing.unit, ing.name, ing.note)
  ),
  recipeInstructions: recipe.steps.map((step, index) => ({
    '@type': 'HowToStep',
    position: index + 1,
    text: step,
  })),
};

// Add datePublished if available
if (recipe.publishedAt) {
  jsonLd.datePublished = recipe.publishedAt.toISOString();
}

// Add image if available and OG images are enabled
if (recipe.image && ogImagesEnabled) {
  // Extract image src (handle both string and object formats)
  const imageSrc = typeof recipe.image === 'string' ? recipe.image : recipe.image.src;
  
  // If image is a relative path, make it absolute
  const imageUrl = imageSrc.startsWith('http')
    ? imageSrc
    : `${siteUrl}${imageSrc.startsWith('/') ? '' : '/'}${imageSrc}`;
  jsonLd.image = imageUrl;
}
---

<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

