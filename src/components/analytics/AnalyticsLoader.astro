---
/**
 * AnalyticsLoader - Consent-gated analytics script loader
 *
 * Only loads analytics scripts if:
 * - analytics.enabled === true
 * - analytics.provider !== 'none'
 * - User has given consent for analytics (consent.analytics === true)
 *
 * Supported providers:
 * - umami: Privacy-focused analytics (default cloud or self-hosted)
 * - plausible: Privacy-focused analytics
 * - ga4: Google Analytics 4
 * - custom: Custom script URL and/or inline script
 *
 * This ensures GDPR/privacy compliance by gating external analytics scripts.
 */

import { siteConfig } from '../../config/site';

const { analytics, legal } = siteConfig.features;
const isDev = import.meta.env.DEV;

// Only render if analytics is enabled and provider is configured
const shouldRender = analytics.enabled && analytics.provider !== 'none';
const consentVersion = legal.consentVersion;

// Build provider-specific data attributes
const providerData = {
  umami: {
    websiteId: analytics.umami?.websiteId || '',
    scriptUrl: analytics.umami?.scriptUrl || 'https://cloud.umami.is/script.js',
  },
  plausible: {
    domain: analytics.plausible?.domain || '',
    scriptUrl: analytics.plausible?.scriptUrl || 'https://plausible.io/js/script.js',
  },
  ga4: {
    measurementId: analytics.ga4?.measurementId || '',
  },
  custom: {
    scriptUrl: analytics.custom?.scriptUrl || '',
    inline: analytics.custom?.inline || '',
  },
};

// Validate configuration in dev mode
function validateConfig(): string[] {
  const warnings: string[] = [];
  
  if (!analytics.enabled) return warnings;
  
  switch (analytics.provider) {
    case 'umami':
      if (!analytics.umami?.websiteId) {
        warnings.push('[Analytics] Umami: websiteId is required but not configured');
      }
      break;
    case 'plausible':
      if (!analytics.plausible?.domain) {
        warnings.push('[Analytics] Plausible: domain is required but not configured');
      }
      break;
    case 'ga4':
      if (!analytics.ga4?.measurementId) {
        warnings.push('[Analytics] GA4: measurementId is required but not configured');
      }
      break;
    case 'custom':
      if (!analytics.custom?.scriptUrl && !analytics.custom?.inline) {
        warnings.push('[Analytics] Custom: either scriptUrl or inline is required but neither is configured');
      }
      break;
  }
  
  return warnings;
}

const devWarnings = isDev ? validateConfig() : [];
---

{shouldRender && (
  <script
    is:inline
    data-consent-version={consentVersion}
    data-provider={analytics.provider}
    data-is-dev={isDev ? 'true' : 'false'}
    data-dev-warnings={JSON.stringify(devWarnings)}
    data-umami-website-id={providerData.umami.websiteId}
    data-umami-script-url={providerData.umami.scriptUrl}
    data-plausible-domain={providerData.plausible.domain}
    data-plausible-script-url={providerData.plausible.scriptUrl}
    data-ga4-measurement-id={providerData.ga4.measurementId}
    data-custom-script-url={providerData.custom.scriptUrl}
    data-custom-inline={providerData.custom.inline}
  >
    (function() {
      try {
        var CONSENT_COOKIE = 'tsk_consent';
        var CONSENT_STORAGE = 'tsk.consent';

        var script = document.currentScript;
        var consentVersion = script.getAttribute('data-consent-version') || '1';
        var provider = script.getAttribute('data-provider');
        var isDev = script.getAttribute('data-is-dev') === 'true';
        var devWarnings = [];
        
        try {
          devWarnings = JSON.parse(script.getAttribute('data-dev-warnings') || '[]');
        } catch (e) {}

        // Log dev warnings
        if (isDev && devWarnings.length > 0) {
          devWarnings.forEach(function(warning) {
            console.warn(warning);
          });
        }

        // Read consent from cookie
        function getCookie(name) {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i];
            var parts = cookie.split('=');
            if (parts[0].trim() === name) {
              try {
                return decodeURIComponent(parts.slice(1).join('='));
              } catch (e) {
                return parts.slice(1).join('=');
              }
            }
          }
          return null;
        }

        // Read consent from cookie or localStorage
        function readConsent(version) {
          // Try cookie first
          var cookieValue = getCookie(CONSENT_COOKIE);
          if (cookieValue) {
            try {
              var parsed = JSON.parse(cookieValue);
              if (parsed && parsed.version === version && parsed.necessary === true) {
                return parsed;
              }
            } catch (e) {}
          }

          // Try localStorage
          try {
            var stored = localStorage.getItem(CONSENT_STORAGE);
            if (stored) {
              var parsed = JSON.parse(stored);
              if (parsed && parsed.version === version && parsed.necessary === true) {
                return parsed;
              }
            }
          } catch (e) {}

          return null;
        }

        var consent = readConsent(consentVersion);

        // Only load analytics if user has given explicit consent
        if (!consent || consent.analytics !== true) {
          if (isDev) {
            console.log('[Analytics] Not loading: analytics consent not granted');
          }
          return;
        }

        // Inject external script
        function injectScript(src, attrs) {
          var s = document.createElement('script');
          s.src = src;
          s.defer = true;
          if (attrs) {
            for (var key in attrs) {
              if (attrs.hasOwnProperty(key)) {
                s.setAttribute(key, attrs[key]);
              }
            }
          }
          document.head.appendChild(s);
          if (isDev) {
            console.log('[Analytics] Injected script:', src);
          }
        }

        // Inject inline script
        function injectInlineScript(code) {
          var s = document.createElement('script');
          s.textContent = code;
          document.head.appendChild(s);
          if (isDev) {
            console.log('[Analytics] Injected inline script');
          }
        }

        // Provider-specific script injection
        switch (provider) {
          case 'umami':
            var umamiWebsiteId = script.getAttribute('data-umami-website-id');
            var umamiScriptUrl = script.getAttribute('data-umami-script-url');
            if (umamiWebsiteId) {
              injectScript(umamiScriptUrl, {
                'data-website-id': umamiWebsiteId
              });
            } else if (isDev) {
              console.warn('[Analytics] Umami: websiteId is empty, skipping script injection');
            }
            break;

          case 'plausible':
            var plausibleDomain = script.getAttribute('data-plausible-domain');
            var plausibleScriptUrl = script.getAttribute('data-plausible-script-url');
            if (plausibleDomain) {
              injectScript(plausibleScriptUrl, {
                'data-domain': plausibleDomain
              });
            } else if (isDev) {
              console.warn('[Analytics] Plausible: domain is empty, skipping script injection');
            }
            break;

          case 'ga4':
            var ga4MeasurementId = script.getAttribute('data-ga4-measurement-id');
            if (ga4MeasurementId) {
              // Load gtag.js
              injectScript('https://www.googletagmanager.com/gtag/js?id=' + ga4MeasurementId);
              // Initialize gtag
              window.dataLayer = window.dataLayer || [];
              function gtag() { window.dataLayer.push(arguments); }
              gtag('js', new Date());
              gtag('config', ga4MeasurementId);
              if (isDev) {
                console.log('[Analytics] GA4 initialized with:', ga4MeasurementId);
              }
            } else if (isDev) {
              console.warn('[Analytics] GA4: measurementId is empty, skipping script injection');
            }
            break;

          case 'custom':
            var customScriptUrl = script.getAttribute('data-custom-script-url');
            var customInline = script.getAttribute('data-custom-inline');
            var hasCustomConfig = false;
            
            // Inject external script if provided
            if (customScriptUrl) {
              injectScript(customScriptUrl);
              hasCustomConfig = true;
            }
            
            // Inject inline script if provided
            if (customInline) {
              injectInlineScript(customInline);
              hasCustomConfig = true;
            }
            
            if (!hasCustomConfig && isDev) {
              console.warn('[Analytics] Custom: neither scriptUrl nor inline provided, skipping');
            }
            break;
            
          default:
            if (isDev) {
              console.warn('[Analytics] Unknown provider:', provider);
            }
        }
      } catch (e) {
        // Fail silently in production, log in dev
        if (typeof isDev !== 'undefined' && isDev) {
          console.error('[Analytics] Error:', e);
        }
      }
    })();
  </script>
)}
