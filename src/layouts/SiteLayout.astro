---
import '../styles/global.css';
import { siteConfig, shouldShowConsentBanner } from '../config/site';
import Button from '../components/ui/Button.astro';
import SearchButton from '../components/search/SearchButton.astro';
import { SearchModal } from '../components/react/SearchModal';
import AdsenseHead from '../components/ads/AdsenseHead.astro';
import AdSlot from '../components/ads/AdSlot.astro';
import ConsentBanner from '../components/legal/ConsentBanner.astro';
import AnalyticsLoader from '../components/analytics/AnalyticsLoader.astro';

interface Props {
  title?: string;
  description?: string;
  canonicalPath?: string;
  ogImage?: string;
}

const { title, description, canonicalPath, ogImage } = Astro.props;

// Build page title
const pageTitle = title ? `${title} — ${siteConfig.site.name}` : siteConfig.site.name;

// Build description (fallback to default)
const pageDescription = description || siteConfig.features.seo.defaultDescription;

// Build canonical URL (only if site.url is set)
const canonicalUrl =
  siteConfig.site.url && canonicalPath
    ? `${siteConfig.site.url}${canonicalPath.startsWith('/') ? '' : '/'}${canonicalPath}`
    : undefined;

// Build OG image URL
const ogImageUrl =
  ogImage && siteConfig.features.seo.ogImages
    ? ogImage.startsWith('http')
      ? ogImage
      : `${siteConfig.site.url}${ogImage.startsWith('/') ? '' : '/'}${ogImage}`
    : siteConfig.features.seo.ogImages && siteConfig.features.seo.ogImagePath
    ? `${siteConfig.site.url}${siteConfig.features.seo.ogImagePath}`
    : undefined;

// Twitter card type
const twitterCard = ogImageUrl ? 'summary_large_image' : 'summary';

// Current path for active link detection
const currentPath = Astro.url.pathname;

// Feature flags
const showSearch = siteConfig.features.search.enabled;
const showAds = siteConfig.features.ads.enabled;
const showSidebarAd = showAds && siteConfig.features.ads.slots.sidebar;
const showBottomBannerAd = showAds && siteConfig.features.ads.slots.bottomBanner;
const showAnalytics = siteConfig.features.analytics.enabled;
const showConsentBanner = shouldShowConsentBanner();

// Navigation items
const navItems = [
  { href: '/', label: 'Home' },
  { href: '/recipes', label: 'Recipes' },
  { href: '/about', label: 'About' },
];

// Helper to check if link is active
function isActive(href: string): boolean {
  if (href === '/') {
    return currentPath === '/';
  }
  return currentPath.startsWith(href);
}

// Current year for copyright
const currentYear = new Date().getFullYear();
---

<!doctype html>
<html lang={siteConfig.site.locale}>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    <meta property="og:title" content={title || siteConfig.site.name} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={title || siteConfig.site.name} />
    <meta name="twitter:description" content={pageDescription} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}
    {siteConfig.features.seo.twitterHandle && (
      <meta name="twitter:creator" content={siteConfig.features.seo.twitterHandle} />
    )}
    <slot name="head" />
    
    {/* AdSense script loader (only when ads enabled + configured) */}
    <AdsenseHead />
  </head>
  <body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to content</a>

    <div class="site-wrapper">
      <!-- Header -->
      <header class="site-header">
        <div class="header-content">
          <a href="/" class="site-logo">
            {siteConfig.site.name}
          </a>
          <nav class="site-nav" aria-label="Main navigation">
            {navItems.map((item) => (
              <Button
                href={item.href}
                variant="ghost"
                size="sm"
                class:list={[{ 'nav-link--active': isActive(item.href) }]}
                aria-current={isActive(item.href) ? 'page' : undefined}
              >
                {item.label}
              </Button>
            ))}
            {showSearch && <SearchButton />}
          </nav>
        </div>
      </header>

      <!-- Main content area with optional sidebar -->
      <div class="content-wrapper">
        <main id="main-content" class:list={["main-content", { "main-content--with-bottom-ad": showBottomBannerAd }]}>
          <slot />
        </main>

        {showSidebarAd && (
          <aside class="sidebar-ad no-print" aria-label="Advertisement">
            <div class="sidebar-ad-container">
              <AdSlot
                slotId={siteConfig.features.ads.adsense.sidebarSlotId}
                format="vertical"
                label="Sidebar ad"
                class="sidebar-ad-slot"
              />
            </div>
          </aside>
        )}
      </div>

      <!-- Footer -->
      <footer class="site-footer">
        <div class="footer-content">
          <p class="footer-tagline">{siteConfig.site.tagline}</p>
          
          <nav class="footer-nav" aria-label="Footer navigation">
            {navItems.map((item) => (
              <a href={item.href} class="footer-link">
                {item.label}
              </a>
            ))}
          </nav>

          <p class="footer-copyright">
            © {currentYear} {siteConfig.site.name}
          </p>
        </div>
      </footer>

      {showBottomBannerAd && (
        <div class="bottom-banner-ad no-print" role="complementary" aria-label="Advertisement">
          <div class="bottom-banner-container">
            <AdSlot
              slotId={siteConfig.features.ads.adsense.bottomSlotId}
              format="horizontal"
              label="Bottom banner ad"
              class="bottom-banner-slot"
              style="width: 100%; min-height: 90px;"
            />
          </div>
        </div>
      )}
    </div>

    {/* Analytics loader - consent-gated */}
    <AnalyticsLoader />

    {/* Consent banner - shown if ads or analytics enabled and legal.consentBanner is true */}
    {showConsentBanner && (
      <ConsentBanner
        version={siteConfig.features.legal.consentVersion}
        siteName={siteConfig.site.name}
        showAds={siteConfig.features.ads.enabled}
        showAnalytics={siteConfig.features.analytics.enabled}
      />
    )}

    {showSearch && (
      <SearchModal 
        client:idle
        siteName={siteConfig.site.name}
        enabled={showSearch}
      />
    )}
  </body>
</html>

<style>
  /* Skip link for keyboard navigation */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 1rem;
    z-index: 1000;
    padding: 0.75rem 1.25rem;
    background: var(--accent);
    color: var(--bg);
    font-weight: 600;
    font-size: 0.875rem;
    border-radius: 0 0 0.5rem 0.5rem;
    text-decoration: none;
    transition: top 0.2s ease;
  }

  .skip-link:focus {
    top: 0;
  }

  /* Site wrapper */
  .site-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Header */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--glass-border);
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
  }

  .site-logo {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    text-decoration: none;
    letter-spacing: -0.02em;
    transition: opacity 0.2s ease;
  }

  .site-logo:hover {
    opacity: 0.8;
  }

  .site-nav {
    display: flex;
    gap: 0.5rem;
  }

  .nav-link--active {
    color: var(--text) !important;
    background: var(--glass-bg) !important;
    border: 1px solid var(--glass-border) !important;
  }

  /* Main content area */
  .content-wrapper {
    display: flex;
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .content-wrapper {
      padding: 3rem 2rem;
    }
  }

  .main-content {
    flex: 1;
    min-width: 0;
  }

  /* Add bottom padding when bottom banner ad is enabled */
  .main-content--with-bottom-ad {
    padding-bottom: 6rem;
  }

  /* Sidebar ad - desktop only */
  .sidebar-ad {
    display: none;
    width: 300px;
    flex-shrink: 0;
  }

  @media (min-width: 1024px) {
    .sidebar-ad {
      display: block;
    }
  }

  .sidebar-ad-container {
    position: sticky;
    top: 5rem; /* Below sticky header */
    width: 300px;
    min-height: 250px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .sidebar-ad-slot {
    width: 100%;
    min-height: 250px;
  }

  /* Bottom banner ad - fixed at bottom */
  .bottom-banner-ad {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 50;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--glass-border);
    padding-bottom: env(safe-area-inset-bottom, 0);
  }

  .bottom-banner-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.5rem 1rem;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bottom-banner-slot {
    width: 100%;
    max-width: 728px; /* Standard leaderboard size */
    min-height: 90px;
  }

  /* Hide ads in print mode */
  @media print {
    .no-print {
      display: none !important;
    }
  }

  /* Footer */
  .site-footer {
    margin-top: auto;
    padding: 2.5rem 1.5rem;
    background: var(--glass-bg);
    border-top: 1px solid var(--glass-border);
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
  }

  @media (min-width: 768px) {
    .footer-content {
      flex-direction: row;
      justify-content: space-between;
      text-align: left;
    }
  }

  .footer-tagline {
    color: var(--muted);
    font-size: 0.875rem;
    font-style: italic;
    opacity: 0.7;
  }

  .footer-nav {
    display: flex;
    gap: 1.5rem;
  }

  .footer-link {
    color: var(--muted);
    font-size: 0.8rem;
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .footer-link:hover {
    color: var(--text);
    opacity: 1;
  }

  .footer-copyright {
    color: var(--muted);
    font-size: 0.75rem;
    opacity: 0.6;
  }

  @media (prefers-reduced-motion: reduce) {
    .skip-link {
      transition: none;
    }
  }
</style>
