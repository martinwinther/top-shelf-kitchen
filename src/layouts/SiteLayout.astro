---
import '../styles/global.css';
import { siteConfig, shouldShowConsentBanner } from '../config/site';
import SearchButton from '../components/search/SearchButton.astro';
import { SearchModal } from '../components/react/SearchModal';
import AdsenseHead from '../components/ads/AdsenseHead.astro';
import AdSlot from '../components/ads/AdSlot.astro';
import ConsentBanner from '../components/legal/ConsentBanner.astro';
import AnalyticsLoader from '../components/analytics/AnalyticsLoader.astro';

interface Props {
  title?: string;
  description?: string;
  canonicalPath?: string;
  ogImage?: string;
}

const { title, description, canonicalPath, ogImage } = Astro.props;

// Build page title
const pageTitle = title ? `${title} — ${siteConfig.site.name}` : siteConfig.site.name;

// Build description (fallback to default)
const pageDescription = description || siteConfig.features.seo.defaultDescription;

// Build canonical URL (only if site.url is set)
const canonicalUrl =
  siteConfig.site.url && canonicalPath
    ? `${siteConfig.site.url}${canonicalPath.startsWith('/') ? '' : '/'}${canonicalPath}`
    : undefined;

// Build OG image URL
const ogImageUrl =
  ogImage && siteConfig.features.seo.ogImages
    ? ogImage.startsWith('http')
      ? ogImage
      : `${siteConfig.site.url}${ogImage.startsWith('/') ? '' : '/'}${ogImage}`
    : siteConfig.features.seo.ogImages && siteConfig.features.seo.ogImagePath
    ? `${siteConfig.site.url}${siteConfig.features.seo.ogImagePath}`
    : undefined;

// Twitter card type
const twitterCard = ogImageUrl ? 'summary_large_image' : 'summary';

// Current path for active link detection
const currentPath = Astro.url.pathname;

// Feature flags
const showSearch = siteConfig.features.search.enabled;
const showAds = siteConfig.features.ads.enabled;
const showSidebarAd = showAds && siteConfig.features.ads.slots.sidebar;
const showBottomBannerAd = showAds && siteConfig.features.ads.slots.bottomBanner;
const showAnalytics = siteConfig.features.analytics.enabled;
const showConsentBanner = shouldShowConsentBanner();

// Navigation items with icons (inline SVG paths)
const navItems = [
  { 
    href: '/', 
    label: 'Home',
    // House icon
    icon: 'M3 9.5L12 3l9 6.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z'
  },
  { 
    href: '/recipes', 
    label: 'Recipes',
    // Utensils icon (fork and knife)
    icon: 'M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7'
  },
  { 
    href: '/about', 
    label: 'About',
    // Info circle icon
    icon: 'M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-14v0m0 4v4'
  },
];

// Helper to check if link is active
function isActive(href: string): boolean {
  if (href === '/') {
    return currentPath === '/';
  }
  return currentPath.startsWith(href);
}

// Current year for copyright
const currentYear = new Date().getFullYear();
---

<!doctype html>
<html lang={siteConfig.site.locale}>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    {canonicalUrl && <link rel="canonical" href={canonicalUrl} />}
    <meta property="og:title" content={title || siteConfig.site.name} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="website" />
    {canonicalUrl && <meta property="og:url" content={canonicalUrl} />}
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={title || siteConfig.site.name} />
    <meta name="twitter:description" content={pageDescription} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}
    {siteConfig.features.seo.twitterHandle && (
      <meta name="twitter:creator" content={siteConfig.features.seo.twitterHandle} />
    )}
    <slot name="head" />
    
    {/* AdSense script loader (only when ads enabled + configured) */}
    <AdsenseHead />
    
    {/* Analytics loader - consent-gated, must be in head */}
    <AnalyticsLoader />
  </head>
  <body>
    <!-- Skip to content link for accessibility -->
    <a href="#main-content" class="skip-link">Skip to content</a>

    <div class="site-wrapper">
      <!-- Header -->
      <header class="site-header" data-pagefind-ignore>
        <div class="header-content">
          <a href="/" class="site-logo">
            {siteConfig.site.name}
          </a>
          <div class="header-actions">
            <nav class="nav-pill" aria-label="Main navigation">
              {navItems.map((item) => (
                <a
                  href={item.href}
                  class:list={['nav-pill-item', { 'nav-pill-item--active': isActive(item.href) }]}
                  aria-current={isActive(item.href) ? 'page' : undefined}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    aria-hidden="true"
                    class="nav-icon"
                  >
                    <path d={item.icon}></path>
                  </svg>
                  <span class="nav-label">{item.label}</span>
                </a>
              ))}
            </nav>
            {showSearch && <SearchButton />}
          </div>
        </div>
      </header>

      <!-- Main content area with optional sidebar -->
      <div class="content-wrapper">
        <main id="main-content" class="main-content">
          <slot />
        </main>

        {showSidebarAd && (
          <aside class="sidebar-ad no-print" aria-label="Advertisement">
            <div class="sidebar-ad-container">
              <AdSlot
                slotId={siteConfig.features.ads.adsense.sidebarSlotId}
                format="vertical"
                label="Sidebar ad"
                class="sidebar-ad-slot"
              />
            </div>
          </aside>
        )}
      </div>

      <!-- Footer -->
      <footer class="site-footer" data-pagefind-ignore>
        <div class="footer-content">
          <p class="footer-tagline">{siteConfig.site.tagline}</p>
          
          <nav class="footer-nav" aria-label="Footer navigation">
            {navItems.map((item) => (
              <a href={item.href} class="footer-link">
                {item.label}
              </a>
            ))}
            {showConsentBanner && (
              <>
                <a href="/privacy" class="footer-link">Privacy</a>
                <button
                  type="button"
                  class="footer-link footer-link--button"
                  data-consent-action="manage"
                  aria-label="Manage cookie consent preferences"
                >
                  Manage consent
                </button>
              </>
            )}
          </nav>

          <p class="footer-copyright">
            © {currentYear} {siteConfig.site.name}
          </p>
        </div>
      </footer>

      {showBottomBannerAd && (
        <div class="bottom-banner-ad no-print" role="complementary" aria-label="Advertisement">
          <div class="bottom-banner-container">
            <AdSlot
              slotId={siteConfig.features.ads.adsense.bottomSlotId}
              format="horizontal"
              label="Bottom banner ad"
              class="bottom-banner-slot"
              style="width: 100%; min-height: 90px;"
            />
          </div>
        </div>
      )}
    </div>

    {/* Consent banner - shown if ads or analytics enabled and legal.consentBanner is true */}
    {showConsentBanner && (
      <ConsentBanner
        version={siteConfig.features.legal.consentVersion}
        siteName={siteConfig.site.name}
        showAds={siteConfig.features.ads.enabled}
        showAnalytics={siteConfig.features.analytics.enabled}
      />
    )}

    {showSearch && (
      <SearchModal 
        client:idle
        siteName={siteConfig.site.name}
        enabled={showSearch}
      />
    )}

    {/* Client-side script to toggle bottom ad spacing based on consent */}
    {showBottomBannerAd && (
      <script
        is:inline
        data-consent-version={siteConfig.features.legal.consentVersion}
      >
        (function() {
          try {
            var CONSENT_COOKIE = 'tsk_consent';
            var CONSENT_STORAGE = 'tsk.consent';
            var script = document.currentScript;
            var version = script.getAttribute('data-consent-version') || '1';

            function getCookie(name) {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                var parts = cookies[i].split('=');
                if (parts[0].trim() === name) {
                  try { return decodeURIComponent(parts.slice(1).join('=')); }
                  catch (e) { return parts.slice(1).join('='); }
                }
              }
              return null;
            }

            function readConsent() {
              var cookieValue = getCookie(CONSENT_COOKIE);
              if (cookieValue) {
                try {
                  var parsed = JSON.parse(cookieValue);
                  if (parsed && parsed.version === version && parsed.necessary === true) return parsed;
                } catch (e) {}
              }
              try {
                var stored = localStorage.getItem(CONSENT_STORAGE);
                if (stored) {
                  var parsed = JSON.parse(stored);
                  if (parsed && parsed.version === version && parsed.necessary === true) return parsed;
                }
              } catch (e) {}
              return null;
            }

            var consent = readConsent();
            if (consent && consent.ads === true) {
              document.documentElement.classList.add('has-bottom-ad');
            }
          } catch (e) {}
        })();
      </script>
    )}
  </body>
</html>

<style>
  /* Skip link for keyboard navigation */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 1rem;
    z-index: 1000;
    padding: 0.75rem 1.25rem;
    background: var(--accent);
    color: var(--bg);
    font-weight: 600;
    font-size: 0.875rem;
    border-radius: 0 0 0.5rem 0.5rem;
    text-decoration: none;
    transition: top 0.2s ease;
  }

  .skip-link:focus {
    top: 0;
  }

  /* Site wrapper */
  .site-wrapper {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  /* Header */
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--glass-border);
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem 1.5rem;
  }

  .site-logo {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    text-decoration: none;
    letter-spacing: -0.02em;
    transition: opacity 0.2s ease;
  }

  .site-logo:hover {
    opacity: 0.8;
  }

  /* Header actions container */
  .header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  /* Navigation pill container */
  .nav-pill {
    display: flex;
    align-items: center;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 9999px;
    padding: 0.25rem;
    gap: 0.125rem;
  }

  /* Individual nav items within pill */
  .nav-pill-item {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.875rem;
    border-radius: 9999px;
    color: var(--muted);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .nav-pill-item:hover {
    color: var(--text);
    background: rgba(255, 255, 255, 0.08);
  }

  .nav-pill-item:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: -2px;
  }

  .nav-pill-item--active {
    color: var(--text);
    background: rgba(255, 255, 255, 0.1);
    /* Accessibility: accent indicator for active state */
    box-shadow: inset 0 -2px 0 0 var(--accent);
  }

  .nav-icon {
    flex-shrink: 0;
    opacity: 0.8;
  }

  .nav-pill-item:hover .nav-icon,
  .nav-pill-item--active .nav-icon {
    opacity: 1;
  }

  .nav-label {
    /* Hide labels on small screens, show icons only */
  }

  @media (max-width: 640px) {
    .nav-label {
      display: none;
    }
    
    .nav-pill-item {
      padding: 0.5rem 0.625rem;
    }
  }

  /* Main content area */
  .content-wrapper {
    display: flex;
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .content-wrapper {
      padding: 3rem 2rem;
    }
  }

  .main-content {
    flex: 1;
    min-width: 0;
  }

  /* Add bottom padding when bottom banner ad is active (consent-aware) */
  :global(.has-bottom-ad) .main-content {
    padding-bottom: 6rem;
  }

  /* Sidebar ad - desktop only */
  .sidebar-ad {
    display: none;
    width: 300px;
    flex-shrink: 0;
  }

  @media (min-width: 1024px) {
    .sidebar-ad {
      display: block;
    }
  }

  .sidebar-ad-container {
    position: sticky;
    top: 5rem; /* Below sticky header */
    width: 300px;
    min-height: 250px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }

  .sidebar-ad-slot {
    width: 100%;
    min-height: 250px;
  }

  /* Bottom banner ad - fixed at bottom */
  .bottom-banner-ad {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 50;
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--glass-border);
    padding-bottom: env(safe-area-inset-bottom, 0);
  }

  .bottom-banner-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0.5rem 1rem;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .bottom-banner-slot {
    width: 100%;
    max-width: 728px; /* Standard leaderboard size */
    min-height: 90px;
  }

  /* Hide ads in print mode */
  @media print {
    .no-print {
      display: none !important;
    }
  }

  /* Footer */
  .site-footer {
    margin-top: auto;
    padding: 2.5rem 1.5rem;
    background: var(--glass-bg);
    border-top: 1px solid var(--glass-border);
  }

  .footer-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
  }

  @media (min-width: 768px) {
    .footer-content {
      flex-direction: row;
      justify-content: space-between;
      text-align: left;
    }
  }

  .footer-tagline {
    color: var(--muted);
    font-size: 0.875rem;
    font-style: italic;
    opacity: 0.7;
  }

  .footer-nav {
    display: flex;
    gap: 1.5rem;
  }

  .footer-link {
    color: var(--muted);
    font-size: 0.8rem;
    text-decoration: none;
    transition: color 0.15s ease;
  }

  .footer-link:hover {
    color: var(--text);
    opacity: 1;
  }

  .footer-link--button {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
  }

  .footer-copyright {
    color: var(--muted);
    font-size: 0.75rem;
    opacity: 0.6;
  }

  @media (prefers-reduced-motion: reduce) {
    .skip-link {
      transition: none;
    }
  }
</style>
