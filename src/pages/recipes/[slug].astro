---
import { getCollection, type CollectionEntry } from 'astro:content';
import SiteLayout from '../../layouts/SiteLayout.astro';
import { getPublishedRecipes, getRecipeSlug } from '../../lib/recipes';
import { siteConfig } from '../../config/site';
import GlassCard from '../../components/ui/GlassCard.astro';
import RecipeHero from '../../components/recipes/RecipeHero.astro';
import IngredientList from '../../components/recipes/IngredientList.astro';
import StepList from '../../components/recipes/StepList.astro';
import RelatedRecipes from '../../components/recipes/RelatedRecipes.astro';
import RecipeJsonLd from '../../components/seo/RecipeJsonLd.astro';
import { RecipeIngredientsScaler } from '../../components/react/RecipeIngredientsScaler';

export async function getStaticPaths() {
  const publishedRecipes = await getPublishedRecipes();
  
  return publishedRecipes.map((recipe) => {
    const slug = getRecipeSlug(recipe);
    return {
      params: { slug },
      props: { recipe },
    };
  });
}

interface Props {
  recipe: CollectionEntry<'recipes'>;
}

const { recipe } = Astro.props;
const slug = getRecipeSlug(recipe);

// SEO metadata
const title = recipe.data.title;
const description = recipe.data.description;
const canonicalPath = `/recipes/${slug}`;
const ogImage = recipe.data.image;
---

<SiteLayout
  title={title}
  description={description}
  canonicalPath={canonicalPath}
  ogImage={ogImage}
>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    {siteConfig.features.seo.jsonLdRecipe && siteConfig.site.url && (
      <RecipeJsonLd
        siteUrl={siteConfig.site.url}
        slug={slug}
        recipe={recipe.data}
        ogImagesEnabled={siteConfig.features.seo.ogImages}
      />
    )}
  </Fragment>

  <article class="recipe-page">
    <a href="/recipes" class="back-link">← All Recipes</a>

    <RecipeHero
      title={recipe.data.title}
      description={recipe.data.description}
      category={recipe.data.category}
      cuisine={recipe.data.cuisine}
      prepMinutes={recipe.data.times.prepMinutes}
      cookMinutes={recipe.data.times.cookMinutes}
      servingsDefault={recipe.data.servingsDefault}
      image={recipe.data.image}
      imageAlt={recipe.data.imageAlt}
    />

    {siteConfig.features.recipeScaling.enabled || siteConfig.features.unitToggle.enabled ? (
      <RecipeIngredientsScaler
        client:load
        slug={slug}
        baseServings={recipe.data.servingsDefault}
        ingredients={recipe.data.ingredients}
        scalingEnabled={siteConfig.features.recipeScaling.enabled}
        unitToggleEnabled={siteConfig.features.unitToggle.enabled}
        defaultUnitSystem={siteConfig.features.unitToggle.default}
      />
    ) : (
      <IngredientList ingredients={recipe.data.ingredients} />
    )}

    <StepList steps={recipe.data.steps} />


    <RelatedRecipes currentSlug={slug} recipes={await getPublishedRecipes()} />

    <nav class="recipe-navigation">
      <a href="/recipes" class="nav-link">Browse all recipes</a>
      <a
        href={`/recipes?category=${recipe.data.category}`}
        class="nav-link"
      >
        More {recipe.data.category} recipes →
      </a>
    </nav>
  </article>
</SiteLayout>

<style>
  .recipe-page {
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding-bottom: 3rem;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.15s ease;
    margin-bottom: -1rem;
    align-self: flex-start;
  }

  .back-link:hover {
    color: var(--text);
    opacity: 1;
  }

  .recipe-notes {
    margin: 2rem 0;
  }

  .recipe-notes-content {
    color: var(--text);
    line-height: 1.7;
    font-size: 1.125rem;
  }

  .recipe-notes-content :global(p) {
    margin: 0 0 1rem 0;
  }

  .recipe-notes-content :global(p:last-child) {
    margin-bottom: 0;
  }

  .recipe-navigation {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 2rem;
    border-top: 1px solid var(--glass-border);
  }

  .nav-link {
    font-size: 1rem;
    color: var(--accent);
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .nav-link:hover {
    opacity: 0.8;
  }

  @media (min-width: 640px) {
    .recipe-navigation {
      flex-direction: row;
      justify-content: space-between;
    }
  }
</style>
