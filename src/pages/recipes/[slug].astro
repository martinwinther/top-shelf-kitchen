---
import { getCollection, render, type CollectionEntry } from 'astro:content';
import SiteLayout from '../../layouts/SiteLayout.astro';
import { getPublishedRecipes, getRecipeSlug } from '../../lib/recipes';
import { siteConfig } from '../../config/site';
import GlassCard from '../../components/ui/GlassCard.astro';
import RecipeHero from '../../components/recipes/RecipeHero.astro';
import IngredientList from '../../components/recipes/IngredientList.astro';
import StepList from '../../components/recipes/StepList.astro';
import RelatedRecipes from '../../components/recipes/RelatedRecipes.astro';
import RecipeJsonLd from '../../components/seo/RecipeJsonLd.astro';
import PrintButton from '../../components/recipes/PrintButton.astro';
import ShareTools from '../../components/recipes/ShareTools.astro';
import { RecipeIngredientsScaler } from '../../components/react/RecipeIngredientsScaler';
import { CookingMode } from '../../components/react/CookingMode';
import GiscusComments from '../../components/comments/GiscusComments.astro';
import NewsletterSignup from '../../components/newsletter/NewsletterSignup.astro';
import { ctaPillClasses } from '../../components/ui/classes';

export async function getStaticPaths() {
  const publishedRecipes = await getPublishedRecipes();
  
  return publishedRecipes.map((recipe) => {
    const slug = getRecipeSlug(recipe);
    return {
      params: { slug },
      props: { recipe },
    };
  });
}

interface Props {
  recipe: CollectionEntry<'recipes'>;
}

const { recipe } = Astro.props;
const slug = getRecipeSlug(recipe);
// Get rendered content from the entry
const { Content } = await render(recipe);

// SEO metadata
const title = recipe.data.title;
const description = recipe.data.description;
const canonicalPath = `/recipes/${slug}`;
const canonicalUrl = `${siteConfig.site.url}${canonicalPath}`;
// Extract image src for ogImage (handle both string and object formats)
const ogImage = recipe.data.image
  ? typeof recipe.data.image === 'string'
    ? recipe.data.image
    : recipe.data.image.src
  : undefined;
---

<SiteLayout
  title={title}
  description={description}
  canonicalPath={canonicalPath}
  ogImage={ogImage}
>
  <Fragment slot="head">
    <meta property="og:type" content="article" />
    {siteConfig.features.seo.jsonLdRecipe && siteConfig.site.url && (
      <RecipeJsonLd
        siteUrl={siteConfig.site.url}
        slug={slug}
        recipe={recipe.data}
        ogImagesEnabled={siteConfig.features.seo.ogImages}
      />
    )}
  </Fragment>

  <article class="recipe-page" data-pagefind-body>
    <a href="/recipes" class="back-link">‚Üê All Recipes</a>

    <RecipeHero
      title={recipe.data.title}
      description={recipe.data.description}
      category={recipe.data.category}
      cuisine={recipe.data.cuisine}
      prepMinutes={recipe.data.times.prepMinutes}
      cookMinutes={recipe.data.times.cookMinutes}
      servingsDefault={recipe.data.servingsDefault}
      image={recipe.data.image}
      imageAlt={recipe.data.imageAlt}
    />

    <div class="recipe-actions no-print">
      {siteConfig.features.cookingMode.enabled && (
        <CookingMode
          client:load
          slug={slug}
          title={recipe.data.title}
          ingredients={recipe.data.ingredients}
          steps={recipe.data.steps}
          unitToggleEnabled={siteConfig.features.unitToggle.enabled}
          scalingEnabled={siteConfig.features.recipeScaling.enabled}
          defaultUnitSystem={siteConfig.features.unitToggle.default}
          baseServings={recipe.data.servingsDefault}
          features={{ keepAwake: siteConfig.features.cookingMode.keepAwake }}
        />
      )}
      <PrintButton />
      <ShareTools title={title} canonicalUrl={canonicalUrl} />
    </div>

    {siteConfig.features.recipeScaling.enabled || siteConfig.features.unitToggle.enabled ? (
      <>
        {/* Interactive scaler - hidden in print */}
        <div class="no-print">
          <RecipeIngredientsScaler
            client:load
            slug={slug}
            baseServings={recipe.data.servingsDefault}
            ingredients={recipe.data.ingredients}
            scalingEnabled={siteConfig.features.recipeScaling.enabled}
            unitToggleEnabled={siteConfig.features.unitToggle.enabled}
            defaultUnitSystem={siteConfig.features.unitToggle.default}
          />
        </div>
        {/* Static ingredient list - print only */}
        <div class="print-only">
          <IngredientList ingredients={recipe.data.ingredients} />
        </div>
      </>
    ) : (
      <IngredientList ingredients={recipe.data.ingredients} />
    )}

    <StepList steps={recipe.data.steps} />

    <section class="recipe-notes">
      <GlassCard>
        <div class="recipe-notes-content">
          <Content />
        </div>
      </GlassCard>
    </section>

    <div class="no-print">
      <RelatedRecipes currentSlug={slug} recipes={await getPublishedRecipes()} />
    </div>

    {siteConfig.features.comments.enabled && (
      <GiscusComments />
    )}

    {siteConfig.features.newsletter.showOnRecipes && (
      <NewsletterSignup compact />
    )}

    <nav class="recipe-navigation">
      <a href="/recipes" class={ctaPillClasses({ size: 'sm' })}>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"></path>
        </svg>
        Browse all recipes
      </a>
      <a
        href={`/recipes?category=${recipe.data.category}`}
        class={ctaPillClasses({ size: 'sm' })}
      >
        More {recipe.data.category} recipes
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          aria-hidden="true"
        >
          <path d="M5 12h14M12 5l7 7-7 7"></path>
        </svg>
      </a>
    </nav>
  </article>
</SiteLayout>

<style>
  .recipe-page {
    max-width: 720px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding-bottom: 3rem;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.15s ease;
    margin-bottom: -1rem;
    align-self: flex-start;
  }

  .back-link:hover {
    color: var(--text);
    opacity: 1;
  }

  .recipe-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
  }

  .recipe-notes {
    margin: 2rem 0;
  }

  .recipe-notes-content {
    color: var(--text);
    line-height: 1.7;
    font-size: 1.125rem;
  }

  .recipe-notes-content :global(p) {
    margin: 0 0 1rem 0;
  }

  .recipe-notes-content :global(p:last-child) {
    margin-bottom: 0;
  }

  .recipe-notes-content :global(img) {
    width: 100%;
    border-radius: var(--radius-xl);
    margin: 1rem 0;
  }

  .recipe-navigation {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding-top: 2rem;
    border-top: 1px solid var(--glass-border);
    align-items: flex-start;
  }

  @media (min-width: 640px) {
    .recipe-navigation {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
    }
  }
</style>
